var Ht=Object.defineProperty;var Vt=(r,n,s)=>n in r?Ht(r,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[n]=s;var Ct=(r,n,s)=>(Vt(r,typeof n!="symbol"?n+"":n,s),s);import{d as ot,c as Kt,o as k,a as x,b as o,e as H,f as W,F as nt,g as vt,t as st,r as It,p as Gt,h as Wt,i as ht,u as J,j as it,n as Qt,w as Jt}from"./index-cd543f1d.js";async function Bt(r){let s=await(await ot.getInstance()).select({from:"Import",where:{id:r}});return s!=null&&s.length?s[0]:null}class bt extends Error{constructor(s,{cause:a=void 0,level:b="error",...S}){super(s,{cause:a});Ct(this,"level");Ct(this,"data");this.level=b,this.data=S}serialize(){return{message:this.message,cause:this.cause,level:this.level,data:this.data}}}function yt(r){return Object.fromEntries(Object.entries(r).map(([n,s])=>[n,s.map(a=>a.toLowerCase())]))}function mt(r,n){n=n.toLowerCase();for(const[s,a]of Object.entries(r))if(a.includes(n))return s;return null}async function Yt(r,n){let s=JSON.parse(r);n.onError||(n.onError=u=>{throw u});const a=u=>{var ft,at;let q;const c=yt({Farsi:["Farsi","Farsi kids fiction","Farsi adults fiction","Persian","Dari","Pashto"],Arabic:["Arabic"],Somali:["Somali"],French:["French"],English:["English"],German:["German"],Greek:["Greek"],Amharic:["Amharic"],Other:["Other"]});let O=(ft=u.language)==null?void 0:ft[0];O=O?mt(c,O):null;let l=u.tags||[];l.map(V=>V.toLowerCase()).includes("English".toLowerCase())&&l.some(V=>{const X=mt(c,V);return X&&X!=="English"})&&(l=l.filter(V=>V.toLowerCase()!=="English".toLowerCase()));for(const V of l){const X=mt(c,V);if(!!X)return O&&X!==O&&(q=new bt(`Language says "${O}" but tags say "${X}"`,{level:"error",bookId:u.books_id,title:u.title}),n.onError(q),u.errors.push(q.serialize())),X}return(at=u.language)!=null&&at[0]?O||"Other":(q=new bt("No language found",{level:"error",bookId:u.books_id,title:u.title}),n.onError(q),u.errors.push(q.serialize()),"Other")},b=u=>{let q;const c=yt({Adults:["Adults","Adult","Adults fiction"],Kids:["Kids","Teen","Farsi kids fiction"]});for(const l of u.tags||[]){const w=mt(c,l);if(w)return w}const O=yt({Adults:["Dictionary"]});for(const l of u.tags||[]){const w=mt(O,l);if(w)return w}return q=new bt('No audience found, falling back to "Adults"',{level:"warning",bookId:u.books_id,title:u.title}),n.onError(q),u.errors.push(q.serialize()),"Adults"},S=u=>{let q;const c=yt({Fiction:["Fiction","Farsi kids fiction","Adults Fiction","Crime Fiction"],"Non fiction":["Non fiction","Health & Fitness","Travel","Cooking","Poetry","Magazine"],"Educational/sciences":["Educational/sciences","Science","Education","Geography","Nature","History","Academic","Culture","Animals","Encyclopedia","Art","Creative","Religion","Handicrafts"],Languages:["Languages","Language Learning","Dictionary","English Readers"]});for(const O of u.tags||[]){const l=mt(c,O);if(l)return l}return q=new bt('No topic found, falling back to "Other"',{level:"warning",bookId:u.books_id,title:u.title}),n.onError(q),u.errors.push(q.serialize()),"Other"};return s=Object.values(s).filter(u=>{const q=u.tags||[];return!q.includes("Board game")&&!q.includes("Cards")}).map(u=>(u.errors=[],{id:u.books_id,title:u.title,language:a(u),audience:b(u),topic:S(u),errors:u.errors})),s}async function Xt(r,n){const s=await ot.getInstance(),b=await Yt(r,{onError:()=>!0});if(b.some(S=>S.errors.length)){const S=b.some(c=>c.errors.some(O=>O.level==="error"))?"error":"warning",u=b.filter(c=>c.errors.length).map(c=>({bookId:c.bookId,title:c.title,errors:c.errors})),q=new bt("Data error",{level:S,errors:u});n.onError(q)}await s.remove({from:"Book"}),await s.insert({into:"Book",values:b}),n.lastModified&&await s.insert({into:"Import",values:[{id:"Book",lastModified:n.lastModified}]})}async function Ft(){const n=await(await ot.getInstance()).count({from:"Book"});if(!n)return null;const s=await Bt("Book");return{count:n,lastModified:s==null?void 0:s.lastModified}}var Ut={exports:{}};(function(r,n){(function(s,a){r.exports=a()})(Kt,function s(){var a=typeof self<"u"?self:typeof window<"u"?window:a!==void 0?a:{},b=!a.document&&!!a.postMessage,S=b&&/blob:/i.test((a.location||{}).protocol),u={},q=0,c={parse:function(e,t){var i=(t=t||{}).dynamicTyping||!1;if(R(i)&&(t.dynamicTypingFunction=i,i={}),t.dynamicTyping=i,t.transform=!!R(t.transform)&&t.transform,t.worker&&c.WORKERS_SUPPORTED){var h=function(){if(!c.WORKERS_SUPPORTED)return!1;var v=(U=a.URL||a.webkitURL||null,F=s.toString(),c.BLOB_URL||(c.BLOB_URL=U.createObjectURL(new Blob(["(",F,")();"],{type:"text/javascript"})))),I=new a.Worker(v),U,F;return I.onmessage=Pt,I.id=q++,u[I.id]=I}();return h.userStep=t.step,h.userChunk=t.chunk,h.userComplete=t.complete,h.userError=t.error,t.step=R(t.step),t.chunk=R(t.chunk),t.complete=R(t.complete),t.error=R(t.error),delete t.worker,void h.postMessage({input:e,config:t,workerId:h.id})}var f=null;return c.NODE_STREAM_INPUT,typeof e=="string"?f=t.download?new w(t):new at(t):e.readable===!0&&R(e.read)&&R(e.on)?f=new V(t):(a.File&&e instanceof File||e instanceof Object)&&(f=new ft(t)),f.stream(e)},unparse:function(e,t){var i=!1,h=!0,f=",",v=`\r
`,I='"',U=I+I,F=!1,p=null,A=!1;(function(){if(typeof t=="object"){if(typeof t.delimiter!="string"||c.BAD_DELIMITERS.filter(function(d){return t.delimiter.indexOf(d)!==-1}).length||(f=t.delimiter),(typeof t.quotes=="boolean"||typeof t.quotes=="function"||Array.isArray(t.quotes))&&(i=t.quotes),typeof t.skipEmptyLines!="boolean"&&typeof t.skipEmptyLines!="string"||(F=t.skipEmptyLines),typeof t.newline=="string"&&(v=t.newline),typeof t.quoteChar=="string"&&(I=t.quoteChar),typeof t.header=="boolean"&&(h=t.header),Array.isArray(t.columns)){if(t.columns.length===0)throw new Error("Option columns is empty");p=t.columns}t.escapeChar!==void 0&&(U=t.escapeChar+I),(typeof t.escapeFormulae=="boolean"||t.escapeFormulae instanceof RegExp)&&(A=t.escapeFormulae instanceof RegExp?t.escapeFormulae:/^[=+\-@\t\r].*$/)}})();var g=new RegExp(gt(I),"g");if(typeof e=="string"&&(e=JSON.parse(e)),Array.isArray(e)){if(!e.length||Array.isArray(e[0]))return tt(null,e,F);if(typeof e[0]=="object")return tt(p||Object.keys(e[0]),e,F)}else if(typeof e=="object")return typeof e.data=="string"&&(e.data=JSON.parse(e.data)),Array.isArray(e.data)&&(e.fields||(e.fields=e.meta&&e.meta.fields||p),e.fields||(e.fields=Array.isArray(e.data[0])?e.fields:typeof e.data[0]=="object"?Object.keys(e.data[0]):[]),Array.isArray(e.data[0])||typeof e.data[0]=="object"||(e.data=[e.data])),tt(e.fields||[],e.data||[],F);throw new Error("Unable to serialize unrecognized input");function tt(d,$,N){var T="";typeof d=="string"&&(d=JSON.parse(d)),typeof $=="string"&&($=JSON.parse($));var j=Array.isArray(d)&&0<d.length,Q=!Array.isArray($[0]);if(j&&h){for(var B=0;B<d.length;B++)0<B&&(T+=f),T+=z(d[B],B);0<$.length&&(T+=v)}for(var m=0;m<$.length;m++){var C=j?d.length:$[m].length,D=!1,M=j?Object.keys($[m]).length===0:$[m].length===0;if(N&&!j&&(D=N==="greedy"?$[m].join("").trim()==="":$[m].length===1&&$[m][0].length===0),N==="greedy"&&j){for(var y=[],E=0;E<C;E++){var L=Q?d[E]:E;y.push($[m][L])}D=y.join("").trim()===""}if(!D){for(var _=0;_<C;_++){0<_&&!M&&(T+=f);var ct=j&&Q?d[_]:_;T+=z($[m][ct],_)}m<$.length-1&&(!N||0<C&&!M)&&(T+=v)}}return T}function z(d,$){if(d==null)return"";if(d.constructor===Date)return JSON.stringify(d).slice(1,25);var N=!1;A&&typeof d=="string"&&A.test(d)&&(d="'"+d,N=!0);var T=d.toString().replace(g,U);return(N=N||i===!0||typeof i=="function"&&i(d,$)||Array.isArray(i)&&i[$]||function(j,Q){for(var B=0;B<Q.length;B++)if(-1<j.indexOf(Q[B]))return!0;return!1}(T,c.BAD_DELIMITERS)||-1<T.indexOf(f)||T.charAt(0)===" "||T.charAt(T.length-1)===" ")?I+T+I:T}}};if(c.RECORD_SEP=String.fromCharCode(30),c.UNIT_SEP=String.fromCharCode(31),c.BYTE_ORDER_MARK="\uFEFF",c.BAD_DELIMITERS=["\r",`
`,'"',c.BYTE_ORDER_MARK],c.WORKERS_SUPPORTED=!b&&!!a.Worker,c.NODE_STREAM_INPUT=1,c.LocalChunkSize=10485760,c.RemoteChunkSize=5242880,c.DefaultDelimiter=",",c.Parser=xt,c.ParserHandle=X,c.NetworkStreamer=w,c.FileStreamer=ft,c.StringStreamer=at,c.ReadableStreamStreamer=V,a.jQuery){var O=a.jQuery;O.fn.parse=function(e){var t=e.config||{},i=[];return this.each(function(v){if(!(O(this).prop("tagName").toUpperCase()==="INPUT"&&O(this).attr("type").toLowerCase()==="file"&&a.FileReader)||!this.files||this.files.length===0)return!0;for(var I=0;I<this.files.length;I++)i.push({file:this.files[I],inputElem:this,instanceConfig:O.extend({},t)})}),h(),this;function h(){if(i.length!==0){var v,I,U,F,p=i[0];if(R(e.before)){var A=e.before(p.file,p.inputElem);if(typeof A=="object"){if(A.action==="abort")return v="AbortError",I=p.file,U=p.inputElem,F=A.reason,void(R(e.error)&&e.error({name:v},I,U,F));if(A.action==="skip")return void f();typeof A.config=="object"&&(p.instanceConfig=O.extend(p.instanceConfig,A.config))}else if(A==="skip")return void f()}var g=p.instanceConfig.complete;p.instanceConfig.complete=function(tt){R(g)&&g(tt,p.file,p.inputElem),f()},c.parse(p.file,p.instanceConfig)}else R(e.complete)&&e.complete()}function f(){i.splice(0,1),h()}}}function l(e){this._handle=null,this._finished=!1,this._completed=!1,this._halted=!1,this._input=null,this._baseIndex=0,this._partialLine="",this._rowCount=0,this._start=0,this._nextChunk=null,this.isFirstChunk=!0,this._completeResults={data:[],errors:[],meta:{}},function(t){var i=Et(t);i.chunkSize=parseInt(i.chunkSize),t.step||t.chunk||(i.chunkSize=null),this._handle=new X(i),(this._handle.streamer=this)._config=i}.call(this,e),this.parseChunk=function(t,i){if(this.isFirstChunk&&R(this._config.beforeFirstChunk)){var h=this._config.beforeFirstChunk(t);h!==void 0&&(t=h)}this.isFirstChunk=!1,this._halted=!1;var f=this._partialLine+t;this._partialLine="";var v=this._handle.parse(f,this._baseIndex,!this._finished);if(!this._handle.paused()&&!this._handle.aborted()){var I=v.meta.cursor;this._finished||(this._partialLine=f.substring(I-this._baseIndex),this._baseIndex=I),v&&v.data&&(this._rowCount+=v.data.length);var U=this._finished||this._config.preview&&this._rowCount>=this._config.preview;if(S)a.postMessage({results:v,workerId:c.WORKER_ID,finished:U});else if(R(this._config.chunk)&&!i){if(this._config.chunk(v,this._handle),this._handle.paused()||this._handle.aborted())return void(this._halted=!0);v=void 0,this._completeResults=void 0}return this._config.step||this._config.chunk||(this._completeResults.data=this._completeResults.data.concat(v.data),this._completeResults.errors=this._completeResults.errors.concat(v.errors),this._completeResults.meta=v.meta),this._completed||!U||!R(this._config.complete)||v&&v.meta.aborted||(this._config.complete(this._completeResults,this._input),this._completed=!0),U||v&&v.meta.paused||this._nextChunk(),v}this._halted=!0},this._sendError=function(t){R(this._config.error)?this._config.error(t):S&&this._config.error&&a.postMessage({workerId:c.WORKER_ID,error:t,finished:!1})}}function w(e){var t;(e=e||{}).chunkSize||(e.chunkSize=c.RemoteChunkSize),l.call(this,e),this._nextChunk=b?function(){this._readChunk(),this._chunkLoaded()}:function(){this._readChunk()},this.stream=function(i){this._input=i,this._nextChunk()},this._readChunk=function(){if(this._finished)this._chunkLoaded();else{if(t=new XMLHttpRequest,this._config.withCredentials&&(t.withCredentials=this._config.withCredentials),b||(t.onload=lt(this._chunkLoaded,this),t.onerror=lt(this._chunkError,this)),t.open(this._config.downloadRequestBody?"POST":"GET",this._input,!b),this._config.downloadRequestHeaders){var i=this._config.downloadRequestHeaders;for(var h in i)t.setRequestHeader(h,i[h])}if(this._config.chunkSize){var f=this._start+this._config.chunkSize-1;t.setRequestHeader("Range","bytes="+this._start+"-"+f)}try{t.send(this._config.downloadRequestBody)}catch(v){this._chunkError(v.message)}b&&t.status===0&&this._chunkError()}},this._chunkLoaded=function(){t.readyState===4&&(t.status<200||400<=t.status?this._chunkError():(this._start+=this._config.chunkSize?this._config.chunkSize:t.responseText.length,this._finished=!this._config.chunkSize||this._start>=function(i){var h=i.getResponseHeader("Content-Range");return h===null?-1:parseInt(h.substring(h.lastIndexOf("/")+1))}(t),this.parseChunk(t.responseText)))},this._chunkError=function(i){var h=t.statusText||i;this._sendError(new Error(h))}}function ft(e){var t,i;(e=e||{}).chunkSize||(e.chunkSize=c.LocalChunkSize),l.call(this,e);var h=typeof FileReader<"u";this.stream=function(f){this._input=f,i=f.slice||f.webkitSlice||f.mozSlice,h?((t=new FileReader).onload=lt(this._chunkLoaded,this),t.onerror=lt(this._chunkError,this)):t=new FileReaderSync,this._nextChunk()},this._nextChunk=function(){this._finished||this._config.preview&&!(this._rowCount<this._config.preview)||this._readChunk()},this._readChunk=function(){var f=this._input;if(this._config.chunkSize){var v=Math.min(this._start+this._config.chunkSize,this._input.size);f=i.call(f,this._start,v)}var I=t.readAsText(f,this._config.encoding);h||this._chunkLoaded({target:{result:I}})},this._chunkLoaded=function(f){this._start+=this._config.chunkSize,this._finished=!this._config.chunkSize||this._start>=this._input.size,this.parseChunk(f.target.result)},this._chunkError=function(){this._sendError(t.error)}}function at(e){var t;l.call(this,e=e||{}),this.stream=function(i){return t=i,this._nextChunk()},this._nextChunk=function(){if(!this._finished){var i,h=this._config.chunkSize;return h?(i=t.substring(0,h),t=t.substring(h)):(i=t,t=""),this._finished=!t,this.parseChunk(i)}}}function V(e){l.call(this,e=e||{});var t=[],i=!0,h=!1;this.pause=function(){l.prototype.pause.apply(this,arguments),this._input.pause()},this.resume=function(){l.prototype.resume.apply(this,arguments),this._input.resume()},this.stream=function(f){this._input=f,this._input.on("data",this._streamData),this._input.on("end",this._streamEnd),this._input.on("error",this._streamError)},this._checkIsFinished=function(){h&&t.length===1&&(this._finished=!0)},this._nextChunk=function(){this._checkIsFinished(),t.length?this.parseChunk(t.shift()):i=!0},this._streamData=lt(function(f){try{t.push(typeof f=="string"?f:f.toString(this._config.encoding)),i&&(i=!1,this._checkIsFinished(),this.parseChunk(t.shift()))}catch(v){this._streamError(v)}},this),this._streamError=lt(function(f){this._streamCleanUp(),this._sendError(f)},this),this._streamEnd=lt(function(){this._streamCleanUp(),h=!0,this._streamData("")},this),this._streamCleanUp=lt(function(){this._input.removeListener("data",this._streamData),this._input.removeListener("end",this._streamEnd),this._input.removeListener("error",this._streamError)},this)}function X(e){var t,i,h,f=Math.pow(2,53),v=-f,I=/^\s*-?(\d+\.?|\.\d+|\d+\.\d+)([eE][-+]?\d+)?\s*$/,U=/^(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))$/,F=this,p=0,A=0,g=!1,tt=!1,z=[],d={data:[],errors:[],meta:{}};if(R(e.step)){var $=e.step;e.step=function(m){if(d=m,j())T();else{if(T(),d.data.length===0)return;p+=m.data.length,e.preview&&p>e.preview?i.abort():(d.data=d.data[0],$(d,F))}}}function N(m){return e.skipEmptyLines==="greedy"?m.join("").trim()==="":m.length===1&&m[0].length===0}function T(){return d&&h&&(B("Delimiter","UndetectableDelimiter","Unable to auto-detect delimiting character; defaulted to '"+c.DefaultDelimiter+"'"),h=!1),e.skipEmptyLines&&(d.data=d.data.filter(function(m){return!N(m)})),j()&&function(){if(!d)return;function m(D,M){R(e.transformHeader)&&(D=e.transformHeader(D,M)),z.push(D)}if(Array.isArray(d.data[0])){for(var C=0;j()&&C<d.data.length;C++)d.data[C].forEach(m);d.data.splice(0,1)}else d.data.forEach(m)}(),function(){if(!d||!e.header&&!e.dynamicTyping&&!e.transform)return d;function m(D,M){var y,E=e.header?{}:[];for(y=0;y<D.length;y++){var L=y,_=D[y];e.header&&(L=y>=z.length?"__parsed_extra":z[y]),e.transform&&(_=e.transform(_,L)),_=Q(L,_),L==="__parsed_extra"?(E[L]=E[L]||[],E[L].push(_)):E[L]=_}return e.header&&(y>z.length?B("FieldMismatch","TooManyFields","Too many fields: expected "+z.length+" fields but parsed "+y,A+M):y<z.length&&B("FieldMismatch","TooFewFields","Too few fields: expected "+z.length+" fields but parsed "+y,A+M)),E}var C=1;return!d.data.length||Array.isArray(d.data[0])?(d.data=d.data.map(m),C=d.data.length):d.data=m(d.data,0),e.header&&d.meta&&(d.meta.fields=z),A+=C,d}()}function j(){return e.header&&z.length===0}function Q(m,C){return D=m,e.dynamicTypingFunction&&e.dynamicTyping[D]===void 0&&(e.dynamicTyping[D]=e.dynamicTypingFunction(D)),(e.dynamicTyping[D]||e.dynamicTyping)===!0?C==="true"||C==="TRUE"||C!=="false"&&C!=="FALSE"&&(function(M){if(I.test(M)){var y=parseFloat(M);if(v<y&&y<f)return!0}return!1}(C)?parseFloat(C):U.test(C)?new Date(C):C===""?null:C):C;var D}function B(m,C,D,M){var y={type:m,code:C,message:D};M!==void 0&&(y.row=M),d.errors.push(y)}this.parse=function(m,C,D){var M=e.quoteChar||'"';if(e.newline||(e.newline=function(L,_){L=L.substring(0,1048576);var ct=new RegExp(gt(_)+"([^]*?)"+gt(_),"gm"),Y=(L=L.replace(ct,"")).split("\r"),K=L.split(`
`),ut=1<K.length&&K[0].length<Y[0].length;if(Y.length===1||ut)return`
`;for(var et=0,G=0;G<Y.length;G++)Y[G][0]===`
`&&et++;return et>=Y.length/2?`\r
`:"\r"}(m,M)),h=!1,e.delimiter)R(e.delimiter)&&(e.delimiter=e.delimiter(m),d.meta.delimiter=e.delimiter);else{var y=function(L,_,ct,Y,K){var ut,et,G,Z;K=K||[",","	","|",";",c.RECORD_SEP,c.UNIT_SEP];for(var dt=0;dt<K.length;dt++){var P=K[dt],pt=0,rt=0,Ot=0;G=void 0;for(var _t=new xt({comments:Y,delimiter:P,newline:_,preview:10}).parse(L),wt=0;wt<_t.data.length;wt++)if(ct&&N(_t.data[wt]))Ot++;else{var kt=_t.data[wt].length;rt+=kt,G!==void 0?0<kt&&(pt+=Math.abs(kt-G),G=kt):G=kt}0<_t.data.length&&(rt/=_t.data.length-Ot),(et===void 0||pt<=et)&&(Z===void 0||Z<rt)&&1.99<rt&&(et=pt,ut=P,Z=rt)}return{successful:!!(e.delimiter=ut),bestDelimiter:ut}}(m,e.newline,e.skipEmptyLines,e.comments,e.delimitersToGuess);y.successful?e.delimiter=y.bestDelimiter:(h=!0,e.delimiter=c.DefaultDelimiter),d.meta.delimiter=e.delimiter}var E=Et(e);return e.preview&&e.header&&E.preview++,t=m,i=new xt(E),d=i.parse(t,C,D),T(),g?{meta:{paused:!0}}:d||{meta:{paused:!1}}},this.paused=function(){return g},this.pause=function(){g=!0,i.abort(),t=R(e.chunk)?"":t.substring(i.getCharIndex())},this.resume=function(){F.streamer._halted?(g=!1,F.streamer.parseChunk(t,!0)):setTimeout(F.resume,3)},this.aborted=function(){return tt},this.abort=function(){tt=!0,i.abort(),d.meta.aborted=!0,R(e.complete)&&e.complete(d),t=""}}function gt(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function xt(e){var t,i=(e=e||{}).delimiter,h=e.newline,f=e.comments,v=e.step,I=e.preview,U=e.fastMode,F=t=e.quoteChar===void 0||e.quoteChar===null?'"':e.quoteChar;if(e.escapeChar!==void 0&&(F=e.escapeChar),(typeof i!="string"||-1<c.BAD_DELIMITERS.indexOf(i))&&(i=","),f===i)throw new Error("Comment character same as delimiter");f===!0?f="#":(typeof f!="string"||-1<c.BAD_DELIMITERS.indexOf(f))&&(f=!1),h!==`
`&&h!=="\r"&&h!==`\r
`&&(h=`
`);var p=0,A=!1;this.parse=function(g,tt,z){if(typeof g!="string")throw new Error("Input must be a string");var d=g.length,$=i.length,N=h.length,T=f.length,j=R(v),Q=[],B=[],m=[],C=p=0;if(!g)return Z();if(U||U!==!1&&g.indexOf(t)===-1){for(var D=g.split(h),M=0;M<D.length;M++){if(m=D[M],p+=m.length,M!==D.length-1)p+=h.length;else if(z)return Z();if(!f||m.substring(0,T)!==f){if(j){if(Q=[],K(m.split(i)),dt(),A)return Z()}else K(m.split(i));if(I&&I<=M)return Q=Q.slice(0,I),Z(!0)}}return Z()}for(var y=g.indexOf(i,p),E=g.indexOf(h,p),L=new RegExp(gt(F)+gt(t),"g"),_=g.indexOf(t,p);;)if(g[p]!==t)if(f&&m.length===0&&g.substring(p,p+T)===f){if(E===-1)return Z();p=E+N,E=g.indexOf(h,p),y=g.indexOf(i,p)}else if(y!==-1&&(y<E||E===-1))m.push(g.substring(p,y)),p=y+$,y=g.indexOf(i,p);else{if(E===-1)break;if(m.push(g.substring(p,E)),G(E+N),j&&(dt(),A))return Z();if(I&&Q.length>=I)return Z(!0)}else for(_=p,p++;;){if((_=g.indexOf(t,_+1))===-1)return z||B.push({type:"Quotes",code:"MissingQuotes",message:"Quoted field unterminated",row:Q.length,index:p}),et();if(_===d-1)return et(g.substring(p,_).replace(L,t));if(t!==F||g[_+1]!==F){if(t===F||_===0||g[_-1]!==F){y!==-1&&y<_+1&&(y=g.indexOf(i,_+1)),E!==-1&&E<_+1&&(E=g.indexOf(h,_+1));var ct=ut(E===-1?y:Math.min(y,E));if(g.substr(_+1+ct,$)===i){m.push(g.substring(p,_).replace(L,t)),g[p=_+1+ct+$]!==t&&(_=g.indexOf(t,p)),y=g.indexOf(i,p),E=g.indexOf(h,p);break}var Y=ut(E);if(g.substring(_+1+Y,_+1+Y+N)===h){if(m.push(g.substring(p,_).replace(L,t)),G(_+1+Y+N),y=g.indexOf(i,p),_=g.indexOf(t,p),j&&(dt(),A))return Z();if(I&&Q.length>=I)return Z(!0);break}B.push({type:"Quotes",code:"InvalidQuotes",message:"Trailing quote on quoted field is malformed",row:Q.length,index:p}),_++}}else _++}return et();function K(P){Q.push(P),C=p}function ut(P){var pt=0;if(P!==-1){var rt=g.substring(_+1,P);rt&&rt.trim()===""&&(pt=rt.length)}return pt}function et(P){return z||(P===void 0&&(P=g.substring(p)),m.push(P),p=d,K(m),j&&dt()),Z()}function G(P){p=P,K(m),m=[],E=g.indexOf(h,p)}function Z(P){return{data:Q,errors:B,meta:{delimiter:i,linebreak:h,aborted:A,truncated:!!P,cursor:C+(tt||0)}}}function dt(){v(Z()),Q=[],B=[]}},this.abort=function(){A=!0},this.getCharIndex=function(){return p}}function Pt(e){var t=e.data,i=u[t.workerId],h=!1;if(t.error)i.userError(t.error,t.file);else if(t.results&&t.results.data){var f={abort:function(){h=!0,$t(t.workerId,{data:[],errors:[],meta:{aborted:!0}})},pause:Dt,resume:Dt};if(R(i.userStep)){for(var v=0;v<t.results.data.length&&(i.userStep({data:t.results.data[v],errors:t.results.errors,meta:t.results.meta},f),!h);v++);delete t.results}else R(i.userChunk)&&(i.userChunk(t.results,f,t.file),delete t.results)}t.finished&&!h&&$t(t.workerId,t.results)}function $t(e,t){var i=u[e];R(i.userComplete)&&i.userComplete(t),i.terminate(),delete u[e]}function Dt(){throw new Error("Not implemented.")}function Et(e){if(typeof e!="object"||e===null)return e;var t=Array.isArray(e)?[]:{};for(var i in e)t[i]=Et(e[i]);return t}function lt(e,t){return function(){e.apply(t,arguments)}}function R(e){return typeof e=="function"}return S&&(a.onmessage=function(e){var t=e.data;if(c.WORKER_ID===void 0&&t&&(c.WORKER_ID=t.workerId),typeof t.input=="string")a.postMessage({workerId:c.WORKER_ID,results:c.parse(t.input,t.config),finished:!0});else if(a.File&&t.input instanceof File||t.input instanceof Object){var i=c.parse(t.input,t.config);i&&a.postMessage({workerId:c.WORKER_ID,results:i,finished:!0})}}),(w.prototype=Object.create(l.prototype)).constructor=w,(ft.prototype=Object.create(l.prototype)).constructor=ft,(at.prototype=Object.create(at.prototype)).constructor=at,(V.prototype=Object.create(l.prototype)).constructor=V,c})})(Ut);const te=Ut.exports;async function ee(r){let n=te.parse(r,{header:!0,skipEmptyLines:!0}).data;return n=n.map(s=>({bookId:s["Item #"],status:s["Item Status"],entryDate:new Date(s["Item Entry date"])})),n}async function ne(r,n){const s=await ot.getInstance();await s.remove({from:"Transaction"}),await s.insert({into:"Transaction",values:await ee(r)}),n.lastModified&&await s.insert({into:"Import",values:[{id:"Transaction",lastModified:n.lastModified}]})}async function Tt(){const n=await(await ot.getInstance()).count({from:"Transaction"});if(!n)return null;const s=await Bt("Transaction");return{count:n,lastModified:s==null?void 0:s.lastModified}}function St(r){return r.toISOString().substring(0,10)}function jt(r){return r.toISOString().substring(0,19).replace("T"," ")}function re(r){return r=new Date(r),new Date(r.getTime()+60*60*24*1e3)}function Lt(r){return r.toLocaleString("fi",{year:"numeric",month:"2-digit",day:"numeric"})}function At(r){return r.toLocaleString("en-US",{weekday:"long"})}const Mt={status:{"Checked out":0,Returned:0,Renewed:0,"New patron":0},language:{Farsi:0,Arabic:0,Somali:0,French:0,English:0,German:0,Greek:0,Amharic:0,Other:0},audience:{Adults:0,Kids:0},topic:{Fiction:0,"Non fiction":0,"Educational/sciences":0,Languages:0,Other:0}};function se(r){return{from:"Transaction",join:{with:"Book",on:"Book.id=Transaction.bookId",as:{id:"bookId",errors:"bookErrors"}},where:{entryDate:{"-":{low:r.dateFrom,high:r.dateTo}}},order:{by:"Transaction.entryDate",type:"asc"}}}function ie(r,n){if(!n.length)return[];const s={};n.forEach(l=>{const w=St(l.entryDate);s[w]=s[w]||{date:w,entries:[],...structuredClone(Mt)},s[w].entries.push(l)});for(const l of Object.values(s))l.entries.forEach(w=>{typeof l.status[w.status]>"u"&&(l.status[w.status]=0),l.status[w.status]++,w.status==="Checked out"&&(typeof l.language[w.language]>"u"&&(l.language[w.language]=0),l.language[w.language]++,typeof l.audience[w.audience]>"u"&&(l.audience[w.audience]=0),l.audience[w.audience]++,typeof l.topic[w.topic]>"u"&&(l.topic[w.topic]=0),l.topic[w.topic]++)});const a=[],b=Object.values(s)[0].date,S=Object.values(s)[Object.keys(s).length-1].date;let u=b;for(;s[u]?a.push(s[u]):a.push({date:u,entries:[],...structuredClone(Mt)}),u!==S;)u=St(re(u));const q=[],c=l=>{let w=new Date(l.date).getDay();return w===0?7:w};let O=0;return a.forEach(l=>{const w=new Date(l.date);c(l)<O&&q.push(Array(35).fill("")),l.entries.length?q.push([Lt(w),At(w),l.status["Checked out"]||0,"","",l.status.Returned||0,"",l.status.Renewed||0,"",l.status["New patron"]||0,"","","",l.language.Farsi||0,l.language.Arabic||0,l.language.Somali||0,l.language.French||0,l.language.English||0,l.language.German||0,l.language.Greek||0,l.language.Amharic||0,l.language.Other||0,"","","",l.audience.Kids||0,l.audience.Adults||0,"","","",l.topic.Fiction||0,l.topic["Non fiction"]||0,l.topic["Educational/sciences"]||0,l.topic.Languages||0,l.topic.Other||0]):c(l)<=5&&q.push([Lt(w),At(w),0,...Array(32).fill("")]),O=c(l)}),q}async function oe(r){const n=se(r),a=await(await ot.getInstance()).select(n);return ie(r,a)}const qt=(r,n)=>{const s=r.__vccOpts||r;for(const[a,b]of n)s[a]=b;return s},ae={emits:["upload"],data(){return{isDragging:!1,file:null}},methods:{onChange(){this.file=this.$refs.file.files[0],this.$emit("upload",this.file)},dragover(r){r.preventDefault(),this.isDragging=!0},dragleave(){this.isDragging=!1},drop(r){r.preventDefault(),this.$refs.file.files=r.dataTransfer.files,this.onChange(),this.isDragging=!1}}},le={key:0,class:"w-full"},ce={for:"fileInput",class:"file-label"},ue={key:0},de={key:1},he=o("u",null,"click here",-1);function fe(r,n,s,a,b,S){return k(),x(nt,null,[b.file?(k(),x("div",le,[o("button",{class:"btn-secondary btn",onClick:n[0]||(n[0]=()=>b.file=null)}," Select another file ")])):H("",!0),b.file?H("",!0):(k(),x("div",{key:1,class:"dropzone-container",onDragover:n[2]||(n[2]=(...u)=>S.dragover&&S.dragover(...u)),onDragleave:n[3]||(n[3]=(...u)=>S.dragleave&&S.dragleave(...u)),onDrop:n[4]||(n[4]=(...u)=>S.drop&&S.drop(...u))},[o("input",{type:"file",name:"file",id:"fileInput",class:"hidden-input",onChange:n[1]||(n[1]=(...u)=>S.onChange&&S.onChange(...u)),ref:"file"},null,544),o("label",ce,[b.isDragging?(k(),x("div",ue,"Release to drop files here.")):(k(),x("div",de,[W("Drop files here or "),he,W(" to upload.")]))])],32))],64)}const zt=qt(ae,[["render",fe]]),pe={class:"inline-block h-5 w-5 stroke-current md:h-6 md:w-6",viewBox:"0 0 24 24",width:"1.5em",height:"1.5em"},me=o("path",{fill:"currentColor",d:"M10 14h4v-2h-4Zm0-3h8V9h-8Zm0-3h8V6h-8ZM8 18q-.825 0-1.412-.587Q6 16.825 6 16V4q0-.825.588-1.413Q7.175 2 8 2h12q.825 0 1.413.587Q22 3.175 22 4v12q0 .825-.587 1.413Q20.825 18 20 18Zm-4 4q-.825 0-1.412-.587Q2 20.825 2 20V6h2v14h14v2Z"},null,-1),ge=[me];function _e(r,n){return k(),x("svg",pe,ge)}const ke={name:"material-symbols-library-books",render:_e},be={class:"inline-block h-5 w-5 stroke-current md:h-6 md:w-6",viewBox:"0 0 24 24",width:"1.5em",height:"1.5em"},ve=o("path",{fill:"currentColor",d:"m13 11.6l2.5 2.5q.275.275.275.7q0 .425-.275.7q-.275.275-.7.275q-.425 0-.7-.275l-2.8-2.8q-.15-.15-.225-.338q-.075-.187-.075-.387V8q0-.425.288-.713Q11.575 7 12 7t.713.287Q13 7.575 13 8ZM12 21q-1.875 0-3.512-.712q-1.638-.713-2.85-1.926q-1.213-1.212-1.926-2.85Q3 13.875 3 12t.712-3.513q.713-1.637 1.926-2.85q1.212-1.212 2.85-1.925Q10.125 3 12 3q2.05 0 3.888.875Q17.725 4.75 19 6.35V5q0-.425.288-.713Q19.575 4 20 4t.712.287Q21 4.575 21 5v4q0 .425-.288.712Q20.425 10 20 10h-4q-.425 0-.712-.288Q15 9.425 15 9t.288-.713Q15.575 8 16 8h1.75q-1.025-1.4-2.525-2.2Q13.725 5 12 5Q9.075 5 7.038 7.037Q5 9.075 5 12q0 2.925 2.038 4.962Q9.075 19 12 19q2.3 0 4.163-1.35q1.862-1.35 2.512-3.55q.125-.425.463-.713q.337-.287.762-.187q.45.1.662.5q.213.4.088.85q-.825 2.875-3.225 4.662Q15.025 21 12 21Z"},null,-1),we=[ve];function ye(r,n){return k(),x("svg",be,we)}const Nt={name:"material-symbols-update-rounded",render:ye},Ie={class:"inline-block h-5 w-5 stroke-current md:h-6 md:w-6",viewBox:"0 0 24 24",width:"1.5em",height:"1.5em"},xe=o("path",{fill:"currentColor",d:"M12 22q-.825 0-1.412-.587Q10 20.825 10 20h4q0 .825-.587 1.413Q12.825 22 12 22Zm-4-3v-2h8v2Zm.25-3q-1.725-1.025-2.737-2.75Q4.5 11.525 4.5 9.5q0-3.125 2.188-5.312Q8.875 2 12 2q3.125 0 5.312 2.188Q19.5 6.375 19.5 9.5q0 2.025-1.012 3.75q-1.013 1.725-2.738 2.75Z"},null,-1),Ee=[xe];function Ce(r,n){return k(),x("svg",Ie,Ee)}const Zt={name:"material-symbols-lightbulb",render:Ce},Se={class:"inline-block h-5 w-5 stroke-current md:h-6 md:w-6",viewBox:"0 0 24 24",width:"1.5em",height:"1.5em"},qe=o("path",{fill:"currentColor",d:"M6 22q-.825 0-1.412-.587Q4 20.825 4 20V4q0-.825.588-1.413Q5.175 2 6 2h8l6 6v4h-2V9h-5V4H6v16h6v2Zm0-2V4v16Zm12.3-5.475l1.075 1.075l-3.875 3.85v1.05h1.05l3.875-3.85l1.05 1.05l-4.3 4.3H14v-3.175Zm3.175 3.175L18.3 14.525l1.45-1.45q.275-.275.7-.275q.425 0 .7.275l1.775 1.775q.275.275.275.7q0 .425-.275.7Z"},null,-1),Re=[qe];function $e(r,n){return k(),x("svg",Se,Re)}const De={name:"material-symbols-edit-document-outline",render:$e},Oe={class:"inline-block h-5 w-5 stroke-current md:h-6 md:w-6",viewBox:"0 0 24 24",width:"1.5em",height:"1.5em"},Fe=o("path",{fill:"currentColor",d:"M12 17q.425 0 .713-.288Q13 16.425 13 16t-.287-.713Q12.425 15 12 15t-.712.287Q11 15.575 11 16t.288.712Q11.575 17 12 17Zm0-4q.425 0 .713-.288Q13 12.425 13 12V8q0-.425-.287-.713Q12.425 7 12 7t-.712.287Q11 7.575 11 8v4q0 .425.288.712q.287.288.712.288Zm0 9q-2.075 0-3.9-.788q-1.825-.787-3.175-2.137q-1.35-1.35-2.137-3.175Q2 14.075 2 12t.788-3.9q.787-1.825 2.137-3.175q1.35-1.35 3.175-2.138Q9.925 2 12 2t3.9.787q1.825.788 3.175 2.138q1.35 1.35 2.137 3.175Q22 9.925 22 12t-.788 3.9q-.787 1.825-2.137 3.175q-1.35 1.35-3.175 2.137Q14.075 22 12 22Zm0-2q3.35 0 5.675-2.325Q20 15.35 20 12q0-3.35-2.325-5.675Q15.35 4 12 4Q8.65 4 6.325 6.325Q4 8.65 4 12q0 3.35 2.325 5.675Q8.65 20 12 20Zm0-8Z"},null,-1),Te=[Fe];function Le(r,n){return k(),x("svg",Oe,Te)}const Ae={name:"material-symbols-error-circle-rounded-outline",render:Le},Me={class:"inline-block h-5 w-5 stroke-current md:h-6 md:w-6",viewBox:"0 0 24 24",width:"1.5em",height:"1.5em"},Qe=o("path",{fill:"currentColor",d:"M1 21L12 2l11 19Zm3.45-2h15.1L12 6ZM12 18q.425 0 .713-.288Q13 17.425 13 17t-.287-.712Q12.425 16 12 16t-.712.288Q11 16.575 11 17t.288.712Q11.575 18 12 18Zm-1-3h2v-5h-2Zm1-2.5Z"},null,-1),Be=[Qe];function Ue(r,n){return k(),x("svg",Me,Be)}const je={name:"material-symbols-warning-outline",render:Ue},Rt=r=>(Gt("data-v-3c485124"),r=r(),Wt(),r),ze={class:"alert alert-error mt-8"},Ne=Rt(()=>o("svg",{xmlns:"http://www.w3.org/2000/svg",class:"stroke-current flex-shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),Ze={class:"text-left"},Pe=Rt(()=>o("h3",{class:"font-bold"}," Errors when importing books ",-1)),He={class:"flex-none"},Ve={class:"table table-compact table-zebra mt-4"},Ke=Rt(()=>o("thead",null,[o("tr",null,[o("th",null,"#"),o("th",null,"Book title"),o("th",null,"Errors"),o("th",null,"Edit")])],-1)),Ge=["innerHTML"],We={class:"flex mb-2 last:mb-0"},Je=["href"],Ye={class:"btn-group my-6"},Xe=["onClick"],tn={emits:["continue"],data(){return{errors:[],pageSize:400,currentPage:0}},async mounted(){const n=await(await ot.getInstance()).select({from:"Book"});this.errors=n.filter(s=>s.errors.length).map(s=>({bookId:s.id,title:s.title,errors:s.errors})),this.errors.sort((s,a)=>s.errors.map(b=>b.message).join(" ").localeCompare(a.errors.map(b=>b.message).join(" ")))},computed:{errorsPage(){return this.errors.slice(this.currentPage*this.pageSize,(this.currentPage+1)*this.pageSize)}}},en=vt({...tn,__name:"BookImportErrors",setup(r){return(n,s)=>(k(),x(nt,null,[o("div",ze,[o("div",null,[Ne,o("div",Ze,[Pe,o("span",null,st(n.errors.length)+" errors found",1)])]),o("div",He,[o("button",{class:"btn btn-sm btn-secondary",onClick:s[0]||(s[0]=a=>n.$emit("continue"))}," Ignore & continue ")])]),o("table",Ve,[Ke,o("tbody",null,[(k(!0),x(nt,null,It(n.errorsPage,(a,b)=>(k(),x("tr",{key:a.bookId},[o("td",null,st(n.currentPage*n.pageSize+b+1),1),o("td",{innerHTML:a.title},null,8,Ge),o("td",null,[(k(!0),x(nt,null,It(a.errors,S=>(k(),x("div",We,[S.level==="error"?(k(),ht(J(Ae),{key:0,class:"text-red-400 mr-1"})):S.level==="warning"?(k(),ht(J(je),{key:1,class:"text-orange-300 mr-1"})):H("",!0),W(" "+st(S.message),1)]))),256))]),o("td",null,[o("a",{href:`https://www.librarything.com/work/edit/${a.bookId}`,title:"Edit book in LibraryThing",rel:"noopener noreferrer",target:"_blank"},[it(J(De))],8,Je)])]))),128))])]),o("div",Ye,[(k(!0),x(nt,null,It([...Array(Math.ceil(n.errors.length/n.pageSize))].keys(),a=>(k(),x("button",{key:a,class:Qt(`btn ${a===n.currentPage?"btn-active":""}`),onClick:()=>n.currentPage=a},st(a+1),11,Xe))),128))])],64))}});const nn=qt(en,[["__scopeId","data-v-3c485124"]]),rn={class:"flex gap-4"},sn={class:"flex-grow shrink-0"},on=o("h2",{class:"text-xl font-bold mb-4"}," Use latest import ",-1),an={class:"card mx-auto w-96 bg-gray-700 shadow-xl"},ln={class:"card-body p-6 text-left"},cn={key:0},un={class:"card-actions justify-center"},dn=o("div",{class:"divider divider-horizontal"},"OR",-1),hn={class:"flex-grow shrink-0"},fn=o("h2",{class:"text-xl font-bold mb-4"}," Upload book database (JSON) ",-1),pn={class:"mt-4 text-orange-400 font-light"},mn=o("a",{class:"link link-primary",href:"https://www.librarything.com/export.php?export_type=json",target:"_blank",rel:"noopener noreferrer"},"here",-1),gn={key:0,class:"radial-progress animate-spin text-gray-300 mt-4",style:{"--value":"90"}},_n={key:0,class:"place-items-center"},kn={props:["bookImport","onImportLatest","onUpload","onContinue"]},bn=vt({...kn,__name:"StepBookImport",setup(r){return(n,s)=>{const a=zt;return k(),x(nt,null,[o("div",rn,[r.bookImport.last?(k(),x(nt,{key:0},[o("div",sn,[on,o("div",an,[o("div",ln,[o("span",null,[it(J(ke),{class:"inline-block"}),W(" "+st(r.bookImport.last.count)+" books ",1)]),r.bookImport.last.lastModified?(k(),x("span",cn,[it(J(Nt),{class:"inline-block"}),W(" updated at "+st(J(jt)(r.bookImport.last.lastModified)),1)])):H("",!0),o("div",un,[o("button",{onClick:s[0]||(s[0]=(...b)=>r.onImportLatest&&r.onImportLatest(...b)),class:"btn btn-sm btn-outline btn-secondary mt-2"}," Import ")])])])]),dn],64)):H("",!0),o("div",hn,[fn,it(a,{onUpload:r.onUpload},null,8,["onUpload"]),o("p",pn,[it(J(Zt)),W(" Get export of books from LibraryThing "),mn,W(". ")]),r.bookImport.status==="loading"?(k(),x("div",gn)):H("",!0)])]),r.bookImport.status==="error"?(k(),x("div",_n,[(k(),ht(nn,{key:r.bookImport.status,onContinue:r.onContinue},null,8,["onContinue"]))])):H("",!0)],64)}}}),vn={class:"inline-block h-5 w-5 stroke-current md:h-6 md:w-6",viewBox:"0 0 24 24",width:"1.5em",height:"1.5em"},wn=o("path",{fill:"currentColor",d:"m8 20l-1.4-1.425L9.175 16H2v-2h7.175L6.6 11.425L8 10l5 5Zm8-6l-5-5l5-5l1.4 1.425L14.825 8H22v2h-7.175l2.575 2.575Z"},null,-1),yn=[wn];function In(r,n){return k(),x("svg",vn,yn)}const xn={name:"material-symbols-compare-arrows",render:In},En={class:"flex gap-4"},Cn={class:"flex-grow shrink-0"},Sn=o("h2",{class:"text-xl font-bold mb-4"}," Use latest import ",-1),qn={class:"card mx-auto w-96 bg-gray-700 shadow-xl"},Rn={class:"card-body p-6 text-left"},$n={key:0},Dn={class:"card-actions justify-center"},On=o("div",{class:"divider divider-horizontal"},"OR",-1),Fn={class:"flex-grow shrink-0"},Tn=o("h2",{class:"text-xl font-bold mb-4"}," Upload transactions (CSV) ",-1),Ln={class:"mt-4 text-orange-400 font-light"},An=o("a",{class:"link link-primary",href:"https://www.librarycat.org/admin/transactions",target:"_blank",rel:"noopener noreferrer"},"here",-1),Mn={key:0,class:"radial-progress animate-spin text-gray-300 mt-4",style:{"--value":"90"}},Qn={props:["txImport","onImportLatest","onUpload"]},Bn=vt({...Qn,__name:"StepTxImport",setup(r){return(n,s)=>{const a=zt;return k(),x("div",En,[r.txImport.last?(k(),x(nt,{key:0},[o("div",Cn,[Sn,o("div",qn,[o("div",Rn,[o("span",null,[it(J(xn),{class:"inline-block"}),W(" "+st(r.txImport.last.count)+" transactions ",1)]),r.txImport.last.lastModified?(k(),x("span",$n,[it(J(Nt),{class:"inline-block"}),W(" updated at "+st(J(jt)(r.txImport.last.lastModified)),1)])):H("",!0),o("div",Dn,[o("button",{onClick:s[0]||(s[0]=(...b)=>r.onImportLatest&&r.onImportLatest(...b)),class:"btn btn-sm btn-outline btn-secondary mt-2"}," Import ")])])])]),On],64)):H("",!0),o("div",Fn,[Tn,it(a,{onUpload:r.onUpload},null,8,["onUpload"]),o("p",Ln,[it(J(Zt)),W(" Get export of transactions from LibraryCat "),An,W(". ")]),r.txImport.status==="loading"?(k(),x("div",Mn)):H("",!0)])])}}}),Un={props:["dateFrom","dateTo","today","onContinue"],emits:["update:dateFrom","update:dateTo"]},jn=o("h2",{class:"text-xl font-bold mb-4"}," Select date range for report ",-1),zn={class:"flex gap-4"},Nn={class:"form-control w-96 max-w-xs"},Zn=o("label",{class:"label"},[o("span",{class:"label-text"},"Date from:")],-1),Pn=["value","max"],Hn={class:"form-control w-96 max-w-xs"},Vn=o("label",{class:"label"},[o("span",{class:"label-text"},"Date to:")],-1),Kn=["value","min"],Gn=["disabled"];function Wn(r,n,s,a,b,S){return k(),x(nt,null,[jn,o("form",{onSubmit:n[2]||(n[2]=Jt((...u)=>s.onContinue&&s.onContinue(...u),["prevent"]))},[o("fieldset",zn,[o("div",Nn,[Zn,o("input",{value:s.dateFrom,onInput:n[0]||(n[0]=u=>r.$emit("update:dateFrom",u.target.value)),max:s.today,type:"date",class:"form-control input input-bordered w-full"},null,40,Pn)]),o("div",Hn,[Vn,o("input",{value:s.dateTo,onInput:n[1]||(n[1]=u=>r.$emit("update:dateTo",u.target.value)),min:s.dateFrom,type:"date",class:"form-control input input-bordered w-full"},null,40,Kn)])]),o("button",{disabled:!s.dateFrom||!s.dateTo,class:"btn btn-wide btn-secondary mt-8",type:"submit"}," Submit ",8,Gn)],32)],64)}const Jn=qt(Un,[["render",Wn]]),Yn={class:"inline-block h-5 w-5 stroke-current md:h-6 md:w-6",viewBox:"0 0 24 24",width:"1.5em",height:"1.5em"},Xn=o("path",{fill:"currentColor",d:"m10.6 13.8l-2.175-2.175q-.275-.275-.675-.275t-.7.3q-.275.275-.275.7q0 .425.275.7L9.9 15.9q.275.275.7.275q.425 0 .7-.275l5.675-5.675q.275-.275.275-.675t-.3-.7q-.275-.275-.7-.275q-.425 0-.7.275ZM12 22q-2.075 0-3.9-.788q-1.825-.787-3.175-2.137q-1.35-1.35-2.137-3.175Q2 14.075 2 12t.788-3.9q.787-1.825 2.137-3.175q1.35-1.35 3.175-2.138Q9.925 2 12 2t3.9.787q1.825.788 3.175 2.138q1.35 1.35 2.137 3.175Q22 9.925 22 12t-.788 3.9q-.787 1.825-2.137 3.175q-1.35 1.35-3.175 2.137Q14.075 22 12 22Z"},null,-1),tr=[Xn];function er(r,n){return k(),x("svg",Yn,tr)}const nr={name:"material-symbols-check-circle-rounded",render:er};function rr(r){return r[0].map((n,s)=>r.map(a=>a[s]))}function sr(r){return`
    <table>
      ${r.map(n=>`
        <tr>
          ${n.map(s=>`
            <td>${s}</td>
          `).join("")}
        </tr>
      `).join("")}
    </table>
  `}const ir={class:"items-center"},or={props:["report"],data(){return{copied:!1}},methods:{copyExcel(){const r=new Blob([this.reportAsExcel],{type:"text/html"});setTimeout(()=>{navigator.clipboard.write([new ClipboardItem({[r.type]:r})]),this.copied=!0},3e3)}},computed:{reportAsExcel(){return sr(rr(this.report))}}},ar=vt({...or,__name:"StepExportReport",setup(r){return(n,s)=>(k(),x("div",ir,[o("button",{onClick:s[0]||(s[0]=(...a)=>n.copyExcel&&n.copyExcel(...a)),class:"btn btn-lg btn-secondary"},[W(" Copy "),n.copied?(k(),ht(J(nr),{key:0,class:"inline-block"})):H("",!0)])]))}}),lr={class:"main"},cr={class:"steps shrink-0 mb-16"},ur=["onClick"],dr={data(){const r=St(new Date);return{steps:{bookImport:"Upload books",txImport:"Upload transactions",dateFilter:"Select dates",exportReport:"Finish"},step:"bookImport",bookImport:{status:"",last:null},txImport:{status:"",errors:null,last:null},today:r,dateFilter:{from:"",to:r},report:null}},async mounted(){window.dbConn=await ot.getInstance(),this.bookImport.last=await Ft(),this.txImport.last=await Tt()},methods:{isStepAccessible(r){switch(r){case"bookImport":return!0;case"txImport":return this.bookImport.status==="success";case"dateFilter":return this.bookImport.status==="success"&&this.txImport.status==="success";case"exportReport":return this.bookImport.status==="success"&&this.txImport.status==="success"&&this.dateFilter.from&&this.dateFilter.to}return!1},isStepActive(r){return Object.keys(this.steps).indexOf(r)<=Object.keys(this.steps).indexOf(this.step)},setStep(r){!this.isStepAccessible(r)||(this.step=r)},handleUploadBooks(r){if(this.bookImport.status="loading",!r)return;const n=new FileReader;n.addEventListener("load",async()=>{await Xt(n.result,{lastModified:new Date(r.lastModified),onError:()=>!0}),this.bookImport.last=await Ft(),this.finishBooks()}),n.readAsText(r)},async finishBooks(r=!1){const s=await(await ot.getInstance()).select({from:"Book"});r||!s.some(a=>a.errors.length)?(this.bookImport.status="success",this.setStep("txImport")):this.bookImport.status="error"},handleUploadTxs(r){if(this.txImport.status="loading",!r)return;const n=new FileReader;n.addEventListener("load",async()=>{await ne(n.result,{lastModified:new Date(r.lastModified)}),this.txImport.last=await Tt(),this.finishTxs()}),n.readAsText(r)},finishTxs(r=!1){this.txImport.status="success",this.setStep("dateFilter")},async handleSubmitDateFilter(){this.report=await oe({dateFrom:new Date(this.dateFilter.from),dateTo:new Date(this.dateFilter.to)}),this.setStep("exportReport")}}},pr=vt({...dr,__name:"index",setup(r){return(n,s)=>(k(),x("div",lr,[o("ul",cr,[(k(!0),x(nt,null,It(n.steps,(a,b)=>(k(),x("li",{key:b,onClick:()=>n.setStep(b),class:Qt(`
          step
          ${n.isStepActive(b)?"step-primary":""}
          ${n.isStepAccessible(b)?"cursor-pointer":"cursor-not-allowed"}
        `)},st(a),11,ur))),128))]),n.step==="bookImport"?(k(),ht(bn,{key:0,bookImport:n.bookImport,onImportLatest:n.finishBooks,onUpload:n.handleUploadBooks,onContinue:()=>n.finishBooks(!0)},null,8,["bookImport","onImportLatest","onUpload","onContinue"])):H("",!0),n.step==="txImport"?(k(),ht(Bn,{key:1,txImport:n.txImport,onImportLatest:n.finishTxs,onUpload:n.handleUploadTxs},null,8,["txImport","onImportLatest","onUpload"])):H("",!0),n.step==="dateFilter"?(k(),ht(Jn,{key:2,dateFrom:n.dateFilter.from,"onUpdate:dateFrom":s[0]||(s[0]=a=>n.dateFilter.from=a),dateTo:n.dateFilter.to,"onUpdate:dateTo":s[1]||(s[1]=a=>n.dateFilter.to=a),today:n.today,onContinue:n.handleSubmitDateFilter},null,8,["dateFrom","dateTo","today","onContinue"])):H("",!0),n.step==="exportReport"?(k(),ht(ar,{key:3,report:n.report},null,8,["report"])):H("",!0)]))}});export{pr as default};
